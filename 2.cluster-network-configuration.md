# 2. Docker Swarm cluster AWS Network configuration

## VPC creation

This VPC will be used to provide EC2 inter-instances networking all over the cluster. In order to create new VPC we need to run following command, and save the `VpcId` to the variable:

```
$ aws ec2 create-vpc --cidr-block 10.0.0.0/24

{
    "Vpc": {
        "CidrBlock": "10.0.0.0/24",
        "DhcpOptionsId": "dopt-130fda79",
        "State": "pending",
        "VpcId": "vpc-0ee00f62537074796",
        "OwnerId": "678005261235",
        "InstanceTenancy": "default",
        "Ipv6CidrBlockAssociationSet": [],
        "CidrBlockAssociationSet": [
            {
                "AssociationId": "vpc-cidr-assoc-0d6a946d35a48e406",
                "CidrBlock": "10.0.0.0/24",
                "CidrBlockState": {
                    "State": "associated"
                }
            }
        ],
        "IsDefault": false,
        "Tags": []
    }
}

$ VPC=vpc-0ee00f62537074796

$ aws ec2 create-tags --resources $VPC --tags Key=Name,Value=production
```

<br><br>

## Internet Gateway creation

Internet gateway serves as the single entrypoint of all outgoing traffic of VPC. In order to get response from the Swarm container we need to create one. Later this gateway will be used in the Route Table specification, after the Subnet will be created.

```
$ aws ec2 create-internet-gateway

{
    "InternetGateway": {
        "Attachments": [],
        "InternetGatewayId": "igw-0ef64205485d8e81a",
        "Tags": []
    }
}

$ IGW=igw-0ef64205485d8e81a

$ aws ec2 create-tags --resources $IGW --tags Key=Name,Value=production
```

<br>

Now VPC needs to be attached to the new Internet Gateway.

```
$ aws ec2 attach-internet-gateway \
  --internet-gateway-id $IGW \
  --vpc-id $VPC
```

<br><br>

## Security group creation

Security Group acts like a set of rules, applied to all incoming and outcomming traffic.

```
$ aws ec2 create-security-group \
  --description "Allows public requestes, SSH and all Docker network communications" \
  --group-name production \
  --vpc-id $VPC

{
    "GroupId": "sg-0177b3a255b9fc450"
}

$ SG=sg-0177b3a255b9fc450

$ aws ec2 create-tags --resources $SG --tags Key=Name,Value=production
```

<br>

Next step is to set up inboud traffic rules. We will allow standart HTTP and HTTPS as well as SSH. Moreover, in order to let Docker Swarm nodes communicate with each other, we will allow specific TCP and UDP ports *(You could find Docker Swarm related ports in the [oficial documentation](https://docs.docker.com/engine/swarm/swarm-tutorial/#open-protocols-and-ports-between-the-hosts))*:

```
$ aws ec2 authorize-security-group-ingress --group-id $SG --cidr 0.0.0.0/0 \
  --protocol tcp --port 22

$ aws ec2 authorize-security-group-ingress --group-id $SG --cidr 0.0.0.0/0 \
  --protocol tcp --port 80

$ aws ec2 authorize-security-group-ingress --group-id $SG --cidr 0.0.0.0/0 \
  --protocol tcp --port 443

$ aws ec2 authorize-security-group-ingress --group-id $SG --cidr 0.0.0.0/0 \
  --protocol tcp --port 2377

$ aws ec2 authorize-security-group-ingress --group-id $SG --cidr 0.0.0.0/0 \
  --protocol tcp --port 7946

$ aws ec2 authorize-security-group-ingress --group-id $SG --cidr 0.0.0.0/0 \
  --protocol udp --port 7946

$ aws ec2 authorize-security-group-ingress --group-id $SG --cidr 0.0.0.0/0 \
  --protocol udp --port 4789
```

<br><br>

## Subnet creation

The subnet is required to launch EC2 instances inside VPC. In order to make sure that containers in the Swarm are able to connect each other, let's create a single subnet for our VPC.

```
$ aws ec2 create-subnet --cidr-block 10.0.0.0/24 --vpc-id $VPC

{
    "Subnet": {
        "AvailabilityZone": "eu-central-1a",
        "AvailabilityZoneId": "euc1-az2",
        "AvailableIpAddressCount": 251,
        "CidrBlock": "10.0.0.0/24",
        "DefaultForAz": false,
        "MapPublicIpOnLaunch": false,
        "State": "pending",
        "SubnetId": "subnet-05d781c4237ffdf39",
        "VpcId": "vpc-0ee00f62537074796",
        "OwnerId": "678005261235",
        "AssignIpv6AddressOnCreation": false,
        "Ipv6CidrBlockAssociationSet": [],
        "SubnetArn": "arn:aws:ec2:eu-central-1:678005261235:subnet/subnet-05d781c4237ffdf39"
    }
}

$ aws ec2 create-tags --resources subnet-05d781c4237ffdf39 --tags Key=Name,Value=production
```

<br><br>

## Route Table configuration

After we have created a subnet, new route table should be automatically created. The easiest way to find it, is through the VPC we have just created:

```
$ aws ec2 describe-route-tables | grep -z $VPC

{
    "RouteTables": [
        {
            "Associations": [
                {
                    "Main": true,
                    "RouteTableAssociationId": "rtbassoc-08289cd725f46116c",
                    "RouteTableId": "rtb-04a74eec07283c2bf",
                    "AssociationState": {
                        "State": "associated"
                    }
                }
            ],
            "PropagatingVgws": [],
            "RouteTableId": "rtb-04a74eec07283c2bf",
            "Routes": [
                {
                    "DestinationCidrBlock": "10.0.0.0/24",
                    "GatewayId": "local",
                    "Origin": "CreateRouteTable",
                    "State": "active"
                }
            ],
            "Tags": [],
            "VpcId": "vpc-0ee00f62537074796",
            "OwnerId": "678005261235"
        },
        {
            "Associations": [
                {
                    "Main": true,
                    "RouteTableAssociationId": "rtbassoc-edb3ed80",
                    "RouteTableId": "rtb-ea99d680",
                    "AssociationState": {
                        "State": "associated"
                    }
                }
            ],
            "PropagatingVgws": [],
            "RouteTableId": "rtb-ea99d680",
            "Routes": [
                {
                    "DestinationCidrBlock": "172.31.0.0/16",
                    "GatewayId": "local",
                    "Origin": "CreateRouteTable",
                    "State": "active"
                },
                {
                    "DestinationCidrBlock": "0.0.0.0/0",
                    "GatewayId": "igw-91f63efa",
                    "Origin": "CreateRoute",
                    "State": "active"
                }
            ],
            "Tags": [],
            "VpcId": "vpc-e1f2278b",
            "OwnerId": "678005261235"
        }
    ]
}

$ RT=rtb-04a74eec07283c2bf

$ aws ec2 create-tags --resources $RT --tags Key=Name,Value=production
```

<br>

Finally, we need to add next rule to make sure that all outcomming traffic from Docker Swarm nodes will reach WWW:

```
$ aws ec2 create-route \
  --route-table-id $RT \
  --destination-cidr-block 0.0.0.0/0 \
  --gateway-id $IGW

{
    "Return": true
}
```